- NAT(Network Address Translation)はプライベートとパブリックでIPアドレスやポート番号を変換する
  - 家庭内LANではルーターが行う
  - マンションの共通回線では、インターネットサービスを提供するための機器で行う
  - テザリングではテザリングしてる端末で行う
- 昔はNATを使ってなかった、ネットワークに繋げるのは1台
  - コンピュータがモデムに接続してアクセスポイントに電話して回線を繋ぐダイアルアップ接続
- ISPはIPv4で割り当ててくれるIPアドレスは基本的に1つなので、このままだと1台しか繋げない
  - IPv6だと違うけど
- NAT機能を持ったルーターをNATルーターという
  - 家庭内用とかだとSOHOルーター
- プライベートIPアドレス
  - インターネットに接続してない環境でも勝手に使って良いIPアドレス
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
  - IANAによって予約された
  - 家庭内LAN、マンションの共用回線、社内LANなどで使われる
  - WAN: Wide Area Network、インターネット側
  - LAN: Local Area Network、家庭内側
- NATルーターはNATテーブルを見て、IPアドレスやポートを変換する
- NATを経由したら、別の人でも送信元は同じグローバルIPアドレスになるので、区別がつかない
- NATルーターを経由して、Webサーバーと通信
  - TCP SYNパケットを送信
  - デフォルトゲートウェイのIPアドレスに送られ、NATルーターに届く
  - 送信元IPアドレスをパブリックなものに変換する。ポート番号も変換する
  - NATテーブルに書く
  - TCPヘッダー, IPヘッダーのチェックサムも更新する
  - サーバー側からは同じIPアドレスから通信が来たように見える
    - 実際にはHTTPヘッダーのuser agentで見分けられる
  - NATルーターのパブリックIPアドレスでLANの複数台の端末が接続できる必要があるので、NATテーブルのエントリーごとにポート番号は変える
- TCP接続をFINパケットを送らずにcloseした場合、NATは気付けないので、どこかのタイミングで切断判定が必要
  - FINを送った場合でも、TCP接続の切断後に切断開始側が入るtime_waitの間はTCPセッションが維持されてる機関としてカウントが必要
- UDPは開始、終了を示すパケットがないので、NATテーブルのエントリが一定時間使われなかったらタイムアウト
- FTP, SIPはTCPでセッションを確立した後、やり取りが始まるが、TCPペイロードでIPアドレスとかも送ったりするので、それの変換が必要
- ICMP、終了の判定も困難、ポートなどの識別子がない
  - ICMPパケットのタイプや中身に応じて変換する
  - 中身のIPアドレスの変換が必要な場合もある
- CGN: Carrier Grade NAT
  - 1つのグローバルIPアドレスをCGNがNATを行い、その中のISPネットワークの中のプライベートIPアドレスに家庭内LANのためのNATルーターが割り振られてる形
  - NAT444とも呼ばれる
  - グローバルIPv4アドレスの利用数を圧縮することが目的
  - P2Pが行えなくなることがある
  - サーバー側のログに全て同じユーザーのログとして残ってしまう
    - cookie, user agentで区別は可能
  - ISP Shared Address: サービスプロバイダネットワークの中だけで使えるアドレス。一般の家庭内LANでは使えない。100.64.0.0/10
- IPv6、ネットワークプレフィックス、NAT、ファイヤーウォール、LNP、フレッツ光