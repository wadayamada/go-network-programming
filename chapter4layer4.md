- IPパケットは消失することがある
  - 物理的な回線の原因やルータの原因
  - クマゼミが卵を産みつける、ショベルカーで掘り起こす、錨で傷つける、庭師がハサミで切る、ハンターが散弾銃で撃つ
  - ルーターの故障、設定ミス、アクセス集中
  - IPはできるだけ頑張る方式であり、届かないこともある。末端が頑張る
  - IPはベストエフォート
- TCPは受け取ったよパケットを受信側が返すことで、到達性を保証する
  - 保証するのは末端の役割
  - 受信確認はack
  - 順序制御
  - 再送制御。
    - ackが届かなかったらパケットを再送する
- 5 tuple
  - 送信元IPアドレス、受信側IPアドレス、送信元ポート番号、受信側ポート番号、プロトコル
  - うちの1つが異なるなら異なるTCPセッションにできる
  - TCPによって複数の通信を同時にすることができる
- TCPを実装するのはカーネル
  - ネットワークインターフェースカードから届いたIPパケットをそれぞれのプロセスのソケットに割り振る
  - IPパケットからIPヘッダを外したのがTCPセグメント
  - カーネルはIPパケットを直接ソケットに渡すのではなく、ソケットバッファで一時待機させてから渡す
    - 届いてないIPパケットがあった場合、ここで届いたやつを一時保存して待つ
  - ソケットに届くのはTCPセグメントからTCPヘッダを外したバイト列
- TCPヘッダー
  - ポート、シークエンス番号、ack番号、Window、チェックサム
- 3way handshakeで接続確立
  - SYN, SYN ACK, ACK
  - SYNでサーバーとクライアントのシークエンス番号を同期する
    - シークエンス番号とは送信するバイトごとにつけられる番号
    ```
    クライアント → サーバ: SYN (SEQ=1000)
    サーバ → クライアント: SYN-ACK (SEQ=5000, ACK=1001)
    クライアント → サーバ: ACK (SEQ=1001, ACK=5001)
    クライアント → サーバ: [データ送信] SEQ=1001, データ(100バイト)
    サーバ → クライアント: ACK (SEQ=5001, ACK=1101)
    クライアント → サーバ: [データ送信] SEQ=1101, データ(100バイト)
    サーバ → クライアント: ACK (SEQ=5001, ACK=1201)
    サーバー → クライアント: [データ送信] SEQ=5001, データ(100バイト)
    クライアント → サーバー: ACK (SEQ=1201, ACK=5101)
    ```
  - 最後のackは受信確認にも使うやつ
- 輻輳制御 
  - TCPセグメント送信量を倍々にする
  - 送信量とはackを待たずに送れる量のことで、これをウィンドウサイズという
  - 喪失が発生したら1に戻す
  - コネクション確立直後はスロースタートだから帯域が狭い
  - それを考えるとコネクションを張りまくるよりは一つの方が良いが、距離が遠い場合はackも遅いので、複数張った方が良かったりする
- HTTP/1.0
  - 1つのTCPコネクションで1つのHTTPリクエスト・レスポンスを行い、TCPコネクション切断
- HTTP/1.1
  - keep aliveの導入
  - ただしリクエスト・レスポンスは直列に1つずつ
- HTTP/2
  - 今まではHTTPリクエスト・レスポンスが終了するとTCPセッションも終了してた
  - 1つのTCPセッションで複数のHTTPリクエストを処理する
  - HTTP/2では1つのTCPセッションで複数のHTTPリクエスト・レスポンスを並行でできるようになる
  - keepaliveはTCPコネクションを使い回すが、並行にはできない。順番に使うだけ。
  - パイプライニングはレスポンスを待たずにじゃんじゃんリクエストできるが、レスポンスは順序通りである必要がある
- HTTP/3
  - UDPをベースとしたQUICを使う
- UDP
  - TCPのように順序制御や輻輳制御や再送制御を行わないため、多少のロスなどは起きる
  - その代わり再送による遅れや、受信確認とか並び替えとか送信量制御とかが起きないため、音声通話などで多少のロスが許容できるがリアルタイム性が求められる場合は使える
  - IPにはユニキャスト、マルチキャスト、ブロードキャストの仕組みがある
    - TCPが使えるのはユニキャストだけ
    - UDPは全て使える
    - ブロードキャストはネットワークセグメント内のすべての機器に送る。
      - 同じルーターに繋がってる機器のこと
    - マルチキャストはマルチキャストグループに参加した機器に送る
  - UDPのヘッダーはポートと長さとチェックサムだけ
